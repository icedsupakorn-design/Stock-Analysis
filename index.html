<!DOCTYPE html>
<html lang="th">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STOCK ANALYSIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Very Dark Background (GitHub Dark) */
            color: #c9d1d9; /* Light Gray Default Text */
            line-height: 1.5;
            padding: 0;
        }
        .container-wrapper {
            max-width: 600px; /* Max width for mobile-friendly view */
            margin: 0 auto;
            padding: 0;
            padding-bottom: 80px; /* Space for fixed button */
        }
        .app-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #0d1117;
            padding: 16px 16px 8px; /* FIX: Consistent horizontal padding (16px) */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .card {
            background-color: #161b22; /* Darker Card Background */
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            margin: 0 16px 16px; /* Consistent horizontal margin (16px) */
            border: 1px solid #30363d;
        }
        /* Style for Accordion Header */
        .accordion-header {
            background-color: #21262d; /* Slightly lighter for clickable area */
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .accordion-header:hover {
            background-color: #30363d;
        }
        .accordion-content {
            padding-top: 16px;
            padding-bottom: 8px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        /* Signal Box */
        .signal-box {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 800;
            display: inline-block;
            font-size: 1.25rem;
        }
        .buy { background-color: #10b981; color: white; }
        .sell { background-color: #ef4444; color: white; }
        .hold { background-color: #f59e0b; color: #161b22; }

        /* Status Icon (Top Right) */
        #connectionStatusContainer {
            position: fixed;
            top: 10px; 
            right: 10px;
            z-index: 1001;
            width: 30px;
            height: 30px;
        }
        .status-success { background-color: #10b981; }
        .status-initial { background-color: #3b82f6; }
        .status-error { background-color: #ef4444; }
        .status-icon {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s;
        }

        /* Fixed Footer Button */
        #fixedActionButtonContainer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 12px 16px;
            background-color: #0d1117;
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3);
            z-index: 999;
        }
        #advancedAnalysisButton {
            width: 100%;
            padding: 14px;
            font-size: 1.125rem;
            font-weight: 700;
        }
        
        /* Input Field Styling */
        input {
            background-color: #21262d !important;
            border-color: #4b5563 !important;
            color: #c9d1d9 !important;
            font-size: 1.25rem !important;
        }
        /* Watchlist Dropdown Header Style Override */
        #watchlistHeader {
            /* Make the watchlist header visually integrate with the card, but still clickable */
            background-color: transparent; 
            border: none;
            padding: 12px 12px; /* Adjusted padding to be smaller */
        }
        #watchlistHeader:hover {
            background-color: #30363d;
        }


        /* Banner Style */
        #strongBuyBanner {
            position: sticky;
            top: 0; /* Changed from fixed to sticky to stack with header */
            width: 100%;
            background-color: #10b981; 
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 700;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            display: none; /* Initial hidden state */
        }
        #strongBuyBanner.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* General Adjustments */
        .info-header {
            font-weight: 700;
            color: #8b949e; 
            margin-top: 12px;
            margin-bottom: 6px;
            border-bottom: 1px solid #30363d; 
            padding-bottom: 4px;
        }
        .target-price {
            font-weight: 800;
            color: #58a6ff; 
        }
        .error-message {
            background-color: #3b0707; /* Dark Red */
            color: #f87171; /* Light Red Text */
            border: 1px solid #4a1919;
            padding: 12px;
            border-radius: 8px;
        }
        .watchlist-item {
            cursor: pointer;
            transition: all 0.15s;
        }
        .watchlist-item:hover {
            background-color: #30363d;
        }
        /* Chart container styling */
        .chart-container-inner {
            width: 100%;
        }
        .reset-button {
             background-color: #4b5563;
             color: #d1d5db;
             padding: 4px 8px;
             border-radius: 4px;
             font-size: 0.8rem;
             font-weight: 600;
             margin-top: 8px;
             transition: background-color 0.15s;
         }
         .reset-button:hover {
             background-color: #6b7280;
         }
         /* Temporary Message Style */
         .temp-message-success {
             background-color: #15452b; /* Dark Green */
             color: #A7F3D0; /* Light Green Text */
             border: 1px solid #059669;
             padding: 8px;
             border-radius: 6px;
             font-size: 0.85rem;
             font-weight: 500;
         }
         .temp-message-error {
             background-color: #581d1d; /* Dark Red */
             color: #FCA5A5; /* Light Red Text */
             border: 1px solid #DC2626;
             padding: 8px;
             border-radius: 6px;
             font-size: 0.85rem;
             font-weight: 500;
         }
    </style>
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');
        
        // --- GLOBAL VARIABLES (Cloud Run / Mock Tickers) ---
        const CLOUD_RUN_HOST = "https://stock-analysis-api-1074266470837.us-central1.run.app";  
        const BACKEND_BASE_URL = `${CLOUD_RUN_HOST}/api/analyze_stock`;
        const BACKEND_TEST_URL = `${CLOUD_RUN_HOST}/api/test_raw_data`; 

        const MOCK_TICKERS = [
            "AAPL - Apple Inc. (S&P 500)", "MSFT - Microsoft Corp. (S&P 500)", "GOOGL - Alphabet Inc. (A) (S&P 500)", 
            "GOOG - Alphabet Inc. (C) (S&P 500)", "AMZN - Amazon.com Inc. (S&P 500)", "NVDA - NVIDIA Corp. (S&P 500)",
            "TSLA - Tesla, Inc. (S&P 500)", "META - Meta Platforms Inc. (S&P 500)", "NFLX - Netflix Inc. (S&P 500)",
            "JPM - JPMorgan Chase & Co. (S&P 500)", "BAC - Bank of America Corp. (S&P 500)",
            "GLD - SPDR Gold Shares (ETF)", 
            "GC=F - Gold Futures (Commodity Ticker)", 
            "BTC-USD - Bitcoin (Major Crypto)", 
            "ETH-USD - Ethereum (Major Crypto)", 
        ];


        let chartInstance = {}; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å null ‡πÄ‡∏õ‡πá‡∏ô Object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏•‡∏≤‡∏¢ Instance ‡∏Ç‡∏≠‡∏á Chart.js
        let debounceTimer; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debounce ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        
        // --- FIREBASE STATE ---
        let db, auth, userId = null;
        let app, isAuthReady = false;
        let watchlistData = []; // State for the watchlist
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- UTILITY: Temporary Message Display ---
        function displayTemporaryMessage(message, type = 'success') {
            const container = document.getElementById('watchlistMessage');
            if (!container) return;

            container.textContent = message;
            container.className = `mt-2 temp-message-${type}`;

            // Clear any previous timer and set a new one
            if (container.messageTimer) {
                clearTimeout(container.messageTimer);
            }
            container.messageTimer = setTimeout(() => {
                container.textContent = '';
                container.className = 'mt-2'; // Reset class
            }, 3000);
        }


        // --- FIREBASE FUNCTIONS (Watchlist) ---

        async function initFirebase() {
            try {
                // --- CUSTOM CONFIGURATION: REPLACE THIS BLOCK IF RUNNING OUTSIDE CANVAS ---
                // *** IMPORTANT: Replace placeholder values with your actual Firebase Web App configuration ***
                const YOUR_FIREBASE_CONFIG = {
                    apiKey: "YOUR_API_KEY_HERE", // üõ°Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Placeholder
                    authDomain: "your-project-id.firebaseapp.com", // üõ°Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Placeholder
                    projectId: "your-project-id", // üõ°Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Placeholder
                    storageBucket: "your-project-id.appspot.com", // üõ°Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Placeholder
                    messagingSenderId: "1234567890", // üõ°Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Placeholder
                    appId: "1:1234567890:web:abcdefg" // üõ°Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Placeholder
                    // measurementId: "G-6T4YFZNNQR" // Optional ID
                };
                
                const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(YOUR_FIREBASE_CONFIG);
                
                // Determine if we should proceed with initialization
                // üõ°Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                let isCustomConfigValid = configString && !configString.includes('YOUR_API_KEY_HERE') && !configString.includes('your-project-id');
                let isCanvasConfigValid = typeof __firebase_config !== 'undefined';


                if (!isCanvasConfigValid && !isCustomConfigValid) {
                    console.warn("Firebase config is missing. Watchlist feature disabled outside Canvas environment.");
                    document.getElementById('watchlistList').innerHTML = `<p class="error-message">‚ùå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° Canvas (‡∏Ç‡∏≤‡∏î Firebase Config). ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ \`YOUR_FIREBASE_CONFIG\` ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì.</p>`;
                    return; // Stop initialization if config is missing
                }
                
                const firebaseConfig = JSON.parse(configString);
                
                // --- Proceed with initialization only if config is present ---
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = crypto.randomUUID(); // Fallback to random ID
                    }
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`; // Display full UID
                    setupWatchlistListener();
                });
            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                
                let errorMessage = e.message;
                
                // NEW: Enhanced error message for auth/api-key-not-valid (HTTP 400)
                if (e.code && (e.code === 'auth/api-key-not-valid' || e.code === 'auth/unauthorized-domain' || e.message.includes('API key is not valid'))) {
                    errorMessage = `
                        ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á (Authentication Error 400): \`${e.code || 'API Key is not valid'}\`
                        <p class="mt-2 font-bold text-red-400">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</p>
                        <ul class="list-disc list-inside ml-4 text-sm mt-1 space-y-1">
                            <li>**‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Anonymous Auth:** ‡πÇ‡∏õ‡∏£‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà **Firebase Console** -> **Authentication** -> **Sign-in method** ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ **Anonymous** ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</li>
                            <li>**‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á API Key:** Key ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÇ‡∏î‡πÄ‡∏°‡∏ô. ‡∏´‡∏≤‡∏Å‡∏£‡∏±‡∏ô‡∏ö‡∏ô GitHub Pages (‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏≠‡∏∑‡πà‡∏ô), ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ô **Google Cloud Console** -> **APIs & Services** -> **Credentials**</li>
                        </ul>
                        <p class="mt-2 text-red-400">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.message}</p>
                    `;
                    document.getElementById('watchlistList').innerHTML = `<div class="error-message">${errorMessage}</div>`;
                } else {
                    document.getElementById('watchlistList').innerHTML = `<p class="error-message">‚ùå Firestore Error: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase/‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô. ${e.message}</p>`;
                }
            }
        }

        function getWatchlistCollectionRef() {
            if (!db || !userId) return null;
            // Private data path: /artifacts/{appId}/users/{userId}/watchlist
            return collection(db, `artifacts/${appId}/users/${userId}/watchlist`);
        }

        function setupWatchlistListener() {
            const colRef = getWatchlistCollectionRef();
            if (!colRef) return;

            onSnapshot(colRef, (snapshot) => {
                watchlistData = [];
                snapshot.forEach((doc) => {
                    watchlistData.push({ id: doc.id, ...doc.data() });
                });
                renderWatchlist();
            }, (error) => {
                console.error("Watchlist Snapshot Error:", error);
                
                let displayHtml = `<p class="text-red-400">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π: ${error.message}</p>`;

                if (error.code === 'permission-denied' || error.message.includes('permission-denied')) {
                    displayHtml = `
                        <div class="error-message">
                            **PERMISSION_DENIED (‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò):**
                            <p class="mt-2 font-bold text-red-400">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 2 ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô Firebase Console:</p>
                            <ul class="list-disc list-inside ml-4 text-sm mt-1 space-y-1">
                                <li>**Authentication:** Anonymous Sign-in ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</li>
                                <li>**Firestore Rules:** ‡∏Å‡∏é‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà Authenticated (auth != null) ‡∏≠‡πà‡∏≤‡∏ô/‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô Collection: \`/artifacts/${appId}/users/${userId}/watchlist\` ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</li>
                            </ul>
                            <p class="mt-2 text-red-400">‡∏£‡∏´‡∏±‡∏™‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.code || error.message}</p>
                        </div>`;
                }
                
                document.getElementById('watchlistList').innerHTML = displayHtml;
            });
        }

        window.addTickerToWatchlist = async function() {
            const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
            if (!symbol) return;
            if (!isAuthReady) {
                displayTemporaryMessage("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î/‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Firebase)", "error");
                return;
            }
            
            if (watchlistData.some(item => item.ticker === symbol)) {
                displayTemporaryMessage(`‡∏´‡∏∏‡πâ‡∏ô ${symbol} ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏ß!`, "error");
                return;
            }

            try {
                const colRef = getWatchlistCollectionRef();
                if (!colRef) throw new Error("Firestore ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô.");

                await addDoc(colRef, {
                    ticker: symbol,
                    createdAt: serverTimestamp()
                });
                document.getElementById('symbolInput').value = '';
                displayTemporaryMessage(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${symbol} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, "success");
            } catch (e) {
                console.error("Error adding to watchlist:", e);
                displayTemporaryMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° ${symbol} ‡πÑ‡∏î‡πâ: ${e.message}`, "error");
            }
        }

        window.removeTickerFromWatchlist = async function(docId, ticker) {
            if (!isAuthReady || !docId) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/watchlist`, docId);
                await deleteDoc(docRef);
                displayTemporaryMessage(`‡∏•‡∏ö ${ticker || '‡∏´‡∏∏‡πâ‡∏ô'} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, "success");
            } catch (e) {
                console.error("Error removing from watchlist:", e);
                displayTemporaryMessage(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ${e.message}`, "error");
            }
        }

        function renderWatchlist() {
            const listContainer = document.getElementById('watchlistList'); // TARGET WATCHLIST LIST
            if (!listContainer) return;

            if (watchlistData.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π</p>';
                return;
            }

            listContainer.innerHTML = watchlistData.map(item => {
                const ticker = item.ticker || 'N/A';
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-900 rounded-lg border border-gray-700 watchlist-item">
                        <span class="text-lg font-bold text-blue-300" onclick="document.getElementById('symbolInput').value='${ticker}'; window.handleSymbolInput('${ticker}')">
                            ${ticker}
                        </span>
                        <button class="text-red-500 hover:text-red-400 p-1 rounded" onclick="event.stopPropagation(); window.removeTickerFromWatchlist('${item.id}', '${ticker}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // --- UTILITY FUNCTIONS (Made global for HTML access) ---

        window.updateConnectionStatus = function(status) {
            const container = document.getElementById('connectionStatusIcon');
             container.innerHTML = '';
            
            if (status === 'initial') {
                container.className = 'status-icon status-initial';
                container.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.554 2.656-1.554 3.42 0L15.46 11.2a1.75 1.75 0 01-1.574 2.55H6.114a1.75 1.75 0 01-1.573-2.55l3.42-8.101zM10 14a1 1 0 100 2 1 1 0 000-2zm-1-6a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                `;
            } else if (status === 'success') {
                container.className = 'status-icon status-success';
                container.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                `;
            } else if (status === 'error') {
                container.className = 'status-icon status-error';
                container.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                `;
            }
        }
        
        /**
         * UPDATED: Parses the EPS Growth rate displayed in the Basic Info DOM (#basicInfoDisplay).
         * FIX: ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á EPS (YoY)' ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
         */
        function getRateFromDOM(elementId) {
            const container = document.getElementById(elementId);
            if (!container) return null;

            // 1. Search within the container for the span element containing the label text.
            const labelSpan = Array.from(container.querySelectorAll('span')).find(span => 
                span.textContent.includes('‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á EPS (YoY)') 
            );

            if (!labelSpan) {
                 console.warn("EPS Growth label not found in DOM.");
                 return null;
            }
            
            // 2. The parent element (div.flex.flex-col) holds both the label and the value.
            const parentDiv = labelSpan.parentElement; 
            if (!parentDiv || !parentDiv.classList.contains('flex-col')) {
                 console.warn("EPS Growth parent div structure incorrect.");
                 return null;
            }
            
            // 3. The value span is the second child of the parent div in the grid item.
            const valueElement = parentDiv.querySelector('span:nth-child(2)');
            
            if (!valueElement) {
                 console.warn("EPS Growth value span (second child) not found.");
                 return null;
            }

            let epsGrowthValue = valueElement.textContent.trim();

            if (epsGrowthValue.includes('N/A')) return null;

            // Clean the string (remove %, trim spaces)
            const cleanedValue = epsGrowthValue.replace('%', '').trim();
            const rate = parseFloat(cleanedValue);

            // Convert percentage (35.30) to decimal (0.353)
            if (isNaN(rate) || rate <= 0) return null;
            
            console.log(`[getRateFromDOM] Extracted Rate: ${rate / 100}`);
            return rate / 100;
        }


        /**
         * UPDATED CALCULATION FUNCTION: Calculates PEG Ratio
         */
        function calculatePegRatio(fwdPE, epsGrowth) {
            // Check for invalid P/E or zero/negative P/E
            if (fwdPE === null || fwdPE === undefined || isNaN(fwdPE) || fwdPE <= 0) return null;
            
            // Check for invalid or non-positive growth rate
            if (epsGrowth === null || epsGrowth === undefined || isNaN(epsGrowth) || epsGrowth <= 0) return null;
            
            // Convert decimal growth rate (0.20) to percentage number (20) for the PEG formula denominator
            const annualGrowthRatePercent = epsGrowth * 100;

            // Double check: if growth is positive but somehow very close to zero after calculation, still avoid division by zero
            if (annualGrowthRatePercent <= 0.001) return null;

            return fwdPE / annualGrowthRatePercent;
        }

        // --- CORE FETCHING & RENDERING (Made global for HTML access) ---

        async function fetchStockData(symbol, date) {
            const payload = {
                ticker: symbol,
                competitors: [],  
                date: date  
            };
            
            const dataUrl = BACKEND_BASE_URL;

            console.log(`[FRONTEND] Sending POST request to ${dataUrl} with payload:`, payload);
            const response = await fetch(dataUrl, {
                method: 'POST',  
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });
            console.log(`[FRONTEND] Received response status: ${response.status}`);
            
            if (!response.ok) {
                const contentType = response.headers.get("content-type");
                let errorBody = 'No detailed error message.';
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const errorJson = await response.json().catch(() => ({ error: 'Unknown server error.' }));
                    errorBody = errorJson.error || errorJson.message || JSON.stringify(errorJson);
                } else if (contentType && contentType.indexOf("text/html") !== -1) {
                    errorBody = await response.text();
                    errorBody = `HTML Error (Check Backend Logs): ${errorBody.substring(0, 100)}...`; 
                }
                
                throw new Error(`Server responded with status ${response.status}: ${errorBody}`);
            }

            const result = await response.json();
            
            if (!result.analysis) {  
                 throw new Error("Backend ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤.");
            }
            
            const competitorsFromBackend = result.competitors || [];

            window.updateConnectionStatus('success');

            // --- CRITICAL FIX: Get EPS Growth from DOM if backend result is null/missing/N/A ---
            let epsGrowth = result.eps_growth;
            
            if (epsGrowth === null || epsGrowth === undefined || isNaN(epsGrowth) || epsGrowth === 0) {
                 console.warn("EPS Growth is missing/invalid from backend response 2. Attempting to retrieve from Basic Info DOM.");
                 
                 // Try to retrieve from the DOM, which was rendered by fetchAndDisplayBasicInfo
                 const epsGrowthFromDOM = getRateFromDOM('basicInfoDisplay');
                 
                 if (epsGrowthFromDOM !== null) {
                     epsGrowth = epsGrowthFromDOM;
                     console.log(`[FRONTEND] Successfully retrieved EPS Growth from DOM: ${epsGrowth * 100}%`);
                 } else {
                     console.warn("[FRONTEND] Failed to retrieve EPS Growth from DOM. Value remains null/N/A.");
                 }
            } else {
                 console.log("[FRONTEND] EPS Growth successfully retrieved from Backend result.");
            }
            // --- END CRITICAL FIX ---


            // --- NOTE: Backend now returns 3 years (3y) of historical data ---
            return {  
                data: result.historical_data || generateMockData(symbol, 750), // 3 years is approx 750 days
                isMock: false,
                companyInfo: {  
                    name: result.name,  
                    sector: 'N/A',  
                    industry: 'N/A',  
                    market_cap: result.market_cap,
                    summary: result.analysis,  
                    exchange: 'N/A',
                    pe_ratio: result.pe_ratio, // Trailing P/E
                    forward_pe: result.forward_pe, // NEW: Forward P/E from Backend
                    peg_ratio: result.peg_ratio, // ADDED: PEG Ratio from Backend (Crucial for Growth Stocks)
                    eps: result.eps,  
                    dividend_yield: result.dividend_yield,
                    // --- NEW FIELDS FROM BACKEND ---
                    return_on_equity: result.return_on_equity,  
                    net_margin: result.net_margin,
                    eps_growth: epsGrowth // UPDATED: ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Backend (‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å DOM)
                    // --- END NEW FIELDS ---
                },
                news: result.news || [], // Array of news objects
                peerComparison: competitorsFromBackend
            };
        }

        function generateMockData(symbol, days) {
            const mockData = [];
            let price = 100 + Math.random() * 50;
            const today = new Date();

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                price = price * (1 + (Math.random() - 0.5) * 0.015);
                
                if (date.getDay() !== 0 && date.getDay() !== 6) {
                    const closePrice = parseFloat(price.toFixed(2));
                    const openPrice = closePrice * (1 - (Math.random() * 0.005 * (Math.random() > 0.5 ? 1 : -1))); 
                    mockData.push({
                        date: date.toISOString().split('T')[0],
                        open: parseFloat(openPrice.toFixed(2)),
                        high: closePrice * (1 + (Math.random() * 0.01)),
                        low: closePrice * (1 - (Math.random() * 0.015)),
                        close: closePrice,
                        volume: Math.floor(Math.random() * 5000000 + 100000)
                    });
                }
            }
            return mockData;
        }

        function formatMarketCap(num) {
            if (num === 0 || num === null || num === undefined) return 'N/A';
            if (num >= 1e12) return (num / 1e12).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'T';  
            if (num >= 1e9) return (num / 1e9).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'B';  
            if (num >= 1e6) return (num / 1e6).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'M';  
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function formatRawDataForDisplay(rawInfo) {
            if (!rawInfo || rawInfo.error) {
                return '<p class="text-red-400">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏¢‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡πÑ‡∏î‡πâ</p>';
            }

            const formatValue = (key, value) => {
                if (value === null || value === undefined || value === 0 || value === 'N/A' || (typeof value === 'number' && isNaN(value))) return 'N/A';
                if (typeof value === 'number') {
                    if (key.includes('Cap')) return formatMarketCap(value);
                    if (key.includes('Price') || key.includes('High') || key.includes('Low')) return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (key.includes('PE') || key.includes('EPS') || key.includes('peg')) return value.toFixed(2); // UPDATED: Format PEG
                    
                    // Format Financial Ratios (ROE, Net Margin, EPS Growth) as percentage
                    if (key.includes('returnOnEquity') || key.includes('profitMargins') || key.includes('netIncomeMargin') || key.includes('eps_growth')) {
                        // Assuming the backend sends a decimal ratio (e.g., 0.0032 for 0.32%)
                        return (value * 100).toFixed(2) + '%';
                    }

                    if (key.includes('Employees')) return value.toLocaleString('en-US');
                }
                if (key === 'longBusinessSummary') {
                    return `<p class="text-sm text-gray-400 whitespace-pre-wrap max-h-40 overflow-y-auto">${String(value).substring(0, 450)}...</p>`;
                }
                return String(value);
            };

            const importantKeys = {
                '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó': 'longName',  // Cleaned: Long Name -> ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                '‡∏´‡∏°‡∏ß‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à': 'sector', // Cleaned: Sector
                '‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏¢‡πà‡∏≠‡∏¢': 'industry', // Cleaned: Industry
                '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': 'fullTimeEmployees', // Cleaned: Full Time Employees
                '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î': 'regularMarketPrice',  // Cleaned: Market Price
                '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î': 'marketCap', // Cleaned: Market Cap
                'P/E (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)': 'trailingPE', // Cleaned: P/E Trailing
                'P/E (‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå)': 'forwardPE', // Cleaned: P/E Forward
                'PEG Ratio': 'pegRatio', 
                'ROE (‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏ï‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô)': 'returnOnEquity',  // Cleaned: ROE (Return on Equity)
                'Net Margin (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)': 'profitMargins',  // Cleaned: Net Margin
                '‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á EPS (YoY)': 'eps_growth', // Cleaned: EPS Growth (YoY Estimate)
                '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 52 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå': 'fiftyTwoWeekHigh', // Cleaned: 52 Week High
                '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î 52 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå': 'fiftyTwoWeekLow', // Cleaned: 52 Week Low
                '‡∏™‡∏£‡∏∏‡∏õ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à': 'longBusinessSummary', // Cleaned: Business Summary
            };
            
            const rawInfoAliases = {
                'returnOnEquity': rawInfo.returnOnEquity,
                'profitMargins': rawInfo.profitMargins,
            };


            const marketPriceValue = rawInfo['regularMarketPrice'];
            const marketPriceDisplay = formatValue('regularMarketPrice', marketPriceValue);
            const companyName = rawInfo.longName || rawInfo.symbol || 'N/A';

            const logoPlaceholder = `
                <div class="flex items-center justify-center w-10 h-10 bg-gray-900 rounded-full border border-blue-600 text-blue-400 text-lg font-bold mr-3 flex-shrink-0">
                    ${(rawInfo.symbol || '?').substring(0, 1)}
                </div>
            `;
            
            const priceCard = `
                <div class="w-full p-4 bg-blue-900/40 rounded-xl shadow-xl border-2 border-blue-500/70 mb-4">
                    <p class="text-sm font-semibold text-blue-300">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                    <p class="text-4xl font-extrabold text-white mt-1">${marketPriceDisplay}</p>
                    <p class="text-xs text-gray-400 mt-1">${rawInfo.currency || 'USD'}</p>
                </div>
            `;
            
            let htmlGridItems = '';  
            let summaryHtml = '';  

            for (const [thaiName, key] of Object.entries(importantKeys)) {
                if (key === 'regularMarketPrice') continue;  
                
                let rawValue = rawInfo[key];
                
                if (key === 'returnOnEquity') {
                    rawValue = rawInfo.returnOnEquity || rawInfo.summaryDetail?.returnOnEquity;
                } else if (key === 'profitMargins') {
                    rawValue = rawInfo.profitMargins || rawInfo.summaryDetail?.profitMargins;
                } else if (key === 'eps_growth') { 
                    rawValue = rawInfo.earningsGrowth || rawInfo.eps_growth || rawInfo.summaryDetail?.earningsGrowth;
                } else if (key === 'forwardPE') {
                    rawValue = rawInfo.forwardPE || rawInfo.summaryDetail?.forwardPE;
                } else if (key === 'pegRatio') {
                    rawValue = rawInfo.pegRatio || rawInfo.summaryDetail?.pegRatio;
                }


                const displayValue = formatValue(key, rawValue);
                
                if (key === 'longBusinessSummary') {
                    summaryHtml = `
                        <h4 class="info-header mt-4 text-lg">${thaiName}:</h4>
                        ${displayValue}  
                    `;
                    continue;
                }
                
                if (displayValue === 'N/A' && !key.includes('P/E') && !key.includes('PEG') && !key.includes('Growth')) continue;  

                htmlGridItems += `
                    <div class="flex flex-col p-3 bg-gray-900/50 rounded-lg border border-gray-700">
                        <span class="text-gray-400 font-medium mb-1">${thaiName}</span>
                        <span class="font-bold text-base text-green-300">${displayValue}</span>
                    </div>
                `;
            }

            let html = `
                <div class="flex items-center mb-4">
                    ${logoPlaceholder}
                    <div>
                        <h3 class="text-2xl font-bold text-gray-100">${companyName} (${rawInfo.symbol || 'N/A'})</h3>
                        <p class="text-xs text-gray-400">${rawInfo.exchange || 'N/A'}</p>
                    </div>
                </div>

                ${marketPriceValue !== undefined && marketPriceValue !== null ? priceCard : ''}

                ${summaryHtml}

                <h4 class="info-header mt-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</h4>
                <div class="grid grid-cols-2 gap-3 text-sm mt-3" id="basicInfoGrid">
                    ${htmlGridItems}
                </div>
            `;
            return html;
        }

        // Overridden in the main script block to add Accordion logic
        window.handleSymbolInput = function(symbol) {
            clearTimeout(debounceTimer);
            const symbolInput = symbol.trim().toUpperCase();
            const basicInfoDisplay = document.getElementById('basicInfoDisplay');
            
            document.getElementById('advancedAnalysisButton').disabled = true;

            basicInfoDisplay.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400 mx-auto"></div><p class="mt-2 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏´‡∏∏‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô...</p></div>';
            document.getElementById('analysisOutput').innerHTML = '<p class="text-gray-400 p-4 border border-gray-700 rounded-lg bg-gray-800">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° **‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å** ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>';
            
            window.updateConnectionStatus('initial');

            if (symbolInput.length < 2) {
                basicInfoDisplay.innerHTML = '<p class="text-gray-400 p-4 rounded-lg bg-gray-800 text-center">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏´‡∏∏‡πâ‡∏ô 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</p>';
                return;  
            }

            debounceTimer = setTimeout(() => {
                fetchAndDisplayBasicInfo(symbolInput);
            }, 800);
        }

        async function fetchAndDisplayBasicInfo(symbol) {
            const basicInfoDisplay = document.getElementById('basicInfoDisplay');
            const advancedAnalysisButton = document.getElementById('advancedAnalysisButton');

            basicInfoDisplay.innerHTML = `<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400 mx-auto"></div><p class="mt-2 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á ${symbol}...</p></div>`;
            advancedAnalysisButton.disabled = true;
            window.updateConnectionStatus('initial');

            try {
                const payload = { ticker: symbol };
                const response = await fetch(BACKEND_TEST_URL, {
                    method: 'POST',  
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    const result = await response.json();
                    let rawInfo = JSON.parse(result.raw_info_json);
                    
                    // Manually assign new fields if available, otherwise default to N/A or null
                    if (rawInfo.summaryDetail) {
                        rawInfo.returnOnEquity = rawInfo.summaryDetail.returnOnEquity;
                        rawInfo.netIncomeMargin = rawInfo.summaryDetail.netIncomeMargin;
                        rawInfo.forwardPE = rawInfo.summaryDetail.forwardPE; // Ensure forwardPE is pulled
                        rawInfo.pegRatio = rawInfo.summaryDetail.pegRatio; // Ensure PEG is pulled
                        rawInfo.eps_growth = rawInfo.summaryDetail.earningsGrowth; // Ensure EPS Growth is pulled
                    }


                    basicInfoDisplay.innerHTML = `
                        <div class="card p-0" style="background-color: transparent; border: none; box-shadow: none; margin: 0;">
                            ${formatRawDataForDisplay(rawInfo)}
                        </div>
                    `;
                    advancedAnalysisButton.disabled = false;
                    window.updateConnectionStatus('success');

                } else {
                    let errorBody = await response.text();
                    basicInfoDisplay.innerHTML = `<p class="error-message">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô ${symbol} ‡∏´‡∏£‡∏∑‡∏≠ Server Error: ${response.status}</p>`;
                    window.updateConnectionStatus('error');
                }
            } catch (error) {
                console.error('Basic Data Fetch Error:', error);
                const backendAdvice = `
                    <p class="font-bold text-red-400 mt-2">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</p>
                    <ul class="list-disc list-inside ml-4 text-sm mt-1 space-y-1">
                        <li>**‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏±‡∏Å:** \`Failed to fetch\` ‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤ Server (Cloud Run) ‡∏≠‡∏≤‡∏à‡∏à‡∏∞ Crash ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (Error 500)</li>
                        <li>**‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå **Dockerfile** ‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á \`RUN apt-get install build-essential\` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö \`yfinance\` ‡πÅ‡∏•‡∏∞ \`pandas\` ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</li>
                        <li>**‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Dockerfile ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÅ‡∏•‡πâ‡∏ß Deploy Cloud Run Service ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</li>
                    </ul>
                `;
                basicInfoDisplay.innerHTML = `<div class="error-message">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Backend ‡πÑ‡∏î‡πâ: ${error.message.includes('Failed to fetch') ? '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Server URL ‡∏´‡∏£‡∏∑‡∏≠ Server Crash' : error.message}${backendAdvice}</div>`;
                window.updateConnectionStatus('error');
            }
        }

        /**
         * NEW FUNCTION: Parses the unstructured AI text summary to extract the final signal and rationale.
         */
        function extractAISignal(aiSummary) {
            let signal = 'HOLD';
            let rationale = ["AI Hybrid Analysis: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"];

            if (!aiSummary || aiSummary.length < 50) return { signal, rationale };

            const summaryUpper = aiSummary.toUpperCase();
            
            // Priority Check: STRONG BUY/SELL
            if (summaryUpper.includes('STRONG BUY') || summaryUpper.includes('‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á') || summaryUpper.includes('‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á')) {
                signal = 'STRONG BUY';
                // Using the full summary as rationale is better for AI content
                rationale = [aiSummary]; 
            } else if (summaryUpper.includes('STRONG SELL') || summaryUpper.includes('‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á')) {
                signal = 'STRONG SELL';
                rationale = [aiSummary];
            }
            // Secondary Check: Standard BUY/SELL
            else if (summaryUpper.includes('BUY') || summaryUpper.includes('‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠') || summaryUpper.includes('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ã‡∏∑‡πâ‡∏≠')) {
                signal = 'BUY';
                rationale = [aiSummary];
            } else if (summaryUpper.includes('SELL') || summaryUpper.includes('‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏¢') || summaryUpper.includes('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏≤‡∏¢')) {
                signal = 'SELL';
                rationale = [aiSummary];
            } else {
                // Default to HOLD and use the summary as rationale if no clear signal found
                rationale = [aiSummary];
            }
            
            return { signal, rationale };
        }


        function calculateEMA(data, period, closePrices) {
            if (closePrices.length < period) {
                return Array(closePrices.length).fill(null);  
            }
            
            const multiplier = 2 / (period + 1);
            let emas = Array(closePrices.length).fill(null);
            
            let sum = 0;
            for (let i = 0; i < period; i++) {
                sum += closePrices[i];
            }
            emas[period - 1] = sum / period;  

            for (let i = period; i < closePrices.length; i++) {
                emas[i] = (closePrices[i] - emas[i - 1]) * multiplier + emas[i - 1];
            }
            
            return emas;  
        }

        function calculateRSI(closePrices, period = 14) {
            if (closePrices.length < period + 1) return null;

            let gains = [];

            for (let i = 1; i < closePrices.length; i++) {
                const change = closePrices[i] - closePrices[i - 1];
                gains.push(Math.max(0, change));
            }

            let changes = [];
            for (let i = closePrices.length - 14; i < closePrices.length; i++) {
                if (i > 0) changes.push(closePrices[i] - closePrices[i - 1]);
            }
            
            if (changes.length < period) return null;
            
            let avgGain = 0;
            let avgLoss = 0;

            for (let i = closePrices.length - period; i < closePrices.length; i++) {
                const change = closePrices[i] - closePrices[i - 1];
                if (change > 0) avgGain += change;
                else avgLoss += Math.abs(change);
            }
            
            avgGain /= period;
            avgLoss /= period;
            
            const rs = avgLoss === 0 ? (avgGain === 0 ? 0 : 100) : (avgGain / avgLoss);
            const rsi = 100 - (100 / (1 + rs));

            return rsi;
        }

        function calculateMACD(closePrices) {
            const EMA12_All = calculateEMA(null, 12, closePrices);
            const EMA26_All = calculateEMA(null, 26, closePrices);
            
            const macdLineSeries = [];
            for (let i = 0; i < closePrices.length; i++) {
                if (EMA12_All[i] !== null && EMA26_All[i] !== null) {
                    macdLineSeries.push(EMA12_All[i] - EMA26_All[i]);
                } else {
                    macdLineSeries.push(null);
                }
            }
            
            const nonNullMacdLine = macdLineSeries.filter(v => v !== null);
            const signalLineSeriesRaw = calculateEMA(null, 9, nonNullMacdLine);
            
            let signalLineSeries = macdLineSeries.map(() => null);
            
            if(signalLineSeriesRaw.length > 0) {
                 for(let i = 0; i < signalLineSeriesRaw.length; i++){
                      if(signalLineSeriesRaw[i] !== null){
                          const originalIndex = closePrices.length - nonNullMacdLine.length + i;
                           if (originalIndex >= 0) {
                              signalLineSeries[originalIndex] = signalLineSeriesRaw[i];
                           }
                      }
                 }
            }
            
            const macdLine = macdLineSeries[macdLineSeries.length - 1];
            const signalLine = signalLineSeries[signalLineSeries.length - 1];
            const histogram = macdLine !== null && signalLine !== null ? macdLine - signalLine : null;


            return {
                macd: macdLine,
                signal: signalLine,
                histogram: histogram,
                macdSeries: macdLineSeries,  
                signalSeries: signalLineSeries  
            };
        }

        function calculateSMA(data, period) {
            if (data.length < period) return null;
            const sum = data.slice(-period).reduce((acc, d) => acc + d.close, 0);  
            return sum / period;
        }

        function calculateStandardDeviation(data, period, sma) {
            if (data.length < period) return 0;
            const periodData = data.slice(-period);
            const variance = periodData.reduce((acc, d) => acc + Math.pow(d.close - sma, 2), 0) / period;
            return Math.sqrt(variance);
        }

        function calculateBollingerBands(data, period, numDeviations) {
            if (data.length < period) return {};
            const sma = calculateSMA(data, period);
            if (sma === null) return {};
            const stdDev = calculateStandardDeviation(data, period, sma);

            return {
                upper: sma + (stdDev * numDeviations),
                middle: sma,
                lower: sma - (stdDev * numDeviations)
            };
        }

        function calculateTrendStrength(currentPrice, indicators, volumeAvg) {
            const { EMA12, EMA26, EMA50, EMA200, RSI, MACD } = indicators;
            let score = 0;  

            if (EMA50 === null || EMA200 === null || EMA12 === null || EMA26 === null || RSI === null) {
                return { strength: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏≠', colorClass: 'strength-weak', score: 0 };
            }

            if (EMA50 > EMA200) score += 1;
            if (currentPrice > EMA200) score += 1;
            
            if (EMA12 > EMA26 && EMA26 > EMA50) score += 1.5;  

            if (MACD.histogram !== null && MACD.histogram > 0) score += 0.5;
            
            // Removed specific RSI range check for general trend strength
            if (RSI !== null) {
                if (RSI > 50) score += 1;  
                else score -= 0.5;
            }

            if (volumeAvg > 0 && indicators.Volume > volumeAvg * 1.5) {  
                score += 0.5;
            }

            let strength = '';
            let colorClass = '';
            
            if (score >= 4) {  
                strength = '‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á (STRONG)';
                colorClass = 'strength-strong';
            } else if (score >= 2) {
                strength = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (MODERATE)';
                colorClass = 'strength-moderate';
            } else {
                strength = '‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠/‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (WEAK)';
                colorClass = 'strength-weak';
            }

            return { strength, colorClass, score };
        }
        
        function analyzeMultiIndicatorSignal(currentPrice, indicators, volumeAvg) {
            const { EMA50, EMA200, RSI, MACD, BB, Volume } = indicators;
            let signal = 'HOLD';
            let rationaleList = [];
            let confidence = 0;  
            
            if (EMA50 === null || EMA200 === null) {
                return { signal: 'HOLD', rationaleList: ["‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• EMA ‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏û‡∏≠"], buyTarget: 'N/A', sellTarget: 'N/A', stopLoss: 'N/A', confidence: 0 };
            }

            const isUptrend = currentPrice > EMA50 && EMA50 > EMA200;
            const isDowntrend = currentPrice < EMA50 && EMA50 < EMA200;

            if (isUptrend) {
                rationaleList.push("‚úî ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (C > EMA50 > EMA200)");
                confidence += 2;
            } else if (isDowntrend) {
                rationaleList.push("‚ùå ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏•‡∏á (C < EMA50 < EMA200)");
                confidence -= 2;
            } else {
                rationaleList.push("‚ûñ ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô/‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏á");
            }

            const isMACDBullishCross = MACD.macd !== null && MACD.signal !== null && MACD.macd > MACD.signal;
            const isMACDBearishCross = MACD.macd !== null && MACD.signal !== null && MACD.macd < MACD.signal;

            if (RSI !== null) {
                let rsiStatus = `RSI (${RSI.toFixed(2)}): `;
                if (RSI > 70) rsiStatus += '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Ç‡∏ï Overbought (‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏¢‡πà‡∏≠)';
                else if (RSI < 30) rsiStatus += '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏Ç‡∏ï Oversold (‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß)';
                else if (RSI >= 50) rsiStatus += '‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á (Bullish Zone)';
                else rsiStatus += '‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ï‡∏±‡∏ß (Bearish Zone)';
                rationaleList.push(`[RSI] ${rsiStatus}`);
            }

            if (volumeAvg > 0) {
                let volStatus = `‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢: `; // Cleaned: Volume -> ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢
                const volRatio = Volume / volumeAvg;
                if (volRatio >= 1.5) volStatus += `‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 20 ‡∏ß‡∏±‡∏ô‡∏ñ‡∏∂‡∏á ${(volRatio * 100 - 100).toFixed(0)}% (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á)`;
                else if (volRatio >= 1.1) volStatus += `‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 20 ‡∏ß‡∏±‡∏ô (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à)`;
                else volStatus += `‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 20 ‡∏ß‡∏±‡∏ô`;
                rationaleList.push(`[Volume] ${volStatus}`);
            }

            if (isMACDBullishCross) {
                rationaleList.push("‚úî MACD Cross: MACD Line ‡∏ï‡∏±‡∏î Signal Line ‡∏Ç‡∏∂‡πâ‡∏ô (‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°‡∏ö‡∏ß‡∏Å)");
                confidence += 1;
            } else if (isMACDBearishCross) {
                rationaleList.push("‚ùå MACD Cross: MACD Line ‡∏ï‡∏±‡∏î Signal Line ‡∏•‡∏á (‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°‡∏•‡∏ö)");
                confidence -= 1;
            }

            const isSellingZone = BB.upper !== undefined && currentPrice >= BB.upper;  
            
            const isVolumeAboveAvg = volumeAvg > 0 && Volume > volumeAvg;

            const isHealthyDip = isUptrend &&  
                                     RSI > 30 && RSI < 50 &&  
                                     currentPrice > EMA200 &&  
                                     currentPrice < EMA50;  

            if (isHealthyDip) {
                signal = 'BUY';
                rationaleList.unshift("‚úî BUY (Dip Opportunity): ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏¢‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö EMA50 ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà RSI ‡∏ä‡∏µ‡πâ‡∏ß‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ï‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô");
                confidence += 2;
                
                if (isMACDBullishCross) {
                    signal = 'STRONG BUY';
                    rationaleList[0] = "‚≠ê STRONG BUY (Dip Confirmation): ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏¢‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå MACD ‡∏ï‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å EMA50";
                    confidence += 1.5;
                }
            }
            
            else if (signal !== 'STRONG BUY' && signal !== 'BUY' && isUptrend && isMACDBullishCross && isVolumeAboveAvg && currentPrice > BB.middle) {
                signal = 'BUY';
                rationaleList.unshift("‚úî BUY (Breakout Confirmation): ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô, MACD ‡∏ï‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô, ‡πÅ‡∏•‡∏∞ Volume ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô");
                if (confidence > 3) {  
                     signal = 'STRONG BUY';
                     rationaleList[0] = "‚≠ê STRONG BUY (Breakout Strength): ‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏°‡∏≤‡∏Å";
                }
            }
            
            else if (isDowntrend && isSellingZone) {
                signal = 'SELL';
                rationaleList.unshift("‚≠ê STRONG SELL: ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏•‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô");
                confidence -= 2;
            }

            let buyTarget = BB.lower !== undefined ? BB.lower.toFixed(2) : 'N/A';
            let sellTarget = BB.upper !== undefined ? BB.upper.toFixed(2) : 'N/A';
            
            let stopLoss = 'N/A';
            const lowerBB = indicators.BB.lower;
            const ema50 = indicators.EMA50;
            
            if (lowerBB !== undefined && ema50 !== null) {
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤
                stopLoss = Math.min(lowerBB, ema50).toFixed(2);
            } else if (lowerBB !== undefined) {
                stopLoss = lowerBB.toFixed(2);
            } else if (ema50 !== null) {
                stopLoss = ema50.toFixed(2);
            }

            return { signal, rationaleList, buyTarget, sellTarget, stopLoss, confidence };
        }
        
        /**
         * CRITICAL UPDATE: analyzeValuation now prioritizes calculated PEG Ratio.
         */
        function analyzeValuation(peRatio, forwardPE, calculatedPegRatio) {
            
            // 1. Prioritize calculated PEG Ratio (Growth Stock Valuation)
            if (calculatedPegRatio !== null && calculatedPegRatio !== undefined && calculatedPegRatio > 0 && !isNaN(calculatedPegRatio)) {
                
                if (calculatedPegRatio < 1.0) {
                    return { value: '‡∏ñ‡∏π‡∏Å (Undervalued) - PEG', class: 'value-good' };
                } else if (calculatedPegRatio >= 1.0 && calculatedPegRatio <= 1.5) { // Use a slightly tighter range for 'Fair Value' for Growth
                    return { value: '‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Fair Value) - PEG', class: 'value-neutral' };
                } else { // calculatedPegRatio > 1.5
                    return { value: '‡πÅ‡∏û‡∏á (Overvalued) - PEG', class: 'value-bad' };
                }
            }

            // 2. Fallback to P/E Forward ratio comparison if PEG is missing or unusable
            if (forwardPE !== null && forwardPE !== undefined && forwardPE > 0 && !isNaN(forwardPE)) {
                if (forwardPE > 40) {
                    return { value: '‡πÅ‡∏û‡∏á (Overvalued) - Fwd PE', class: 'value-bad' };
                } else if (forwardPE >= 20) {
                    return { value: '‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Fair Value) - Fwd PE', class: 'value-neutral' };
                } else {
                    return { value: '‡∏ñ‡∏π‡∏Å (Undervalued) - Fwd PE', class: 'value-good' };
                }
            }

            // 3. Fallback to Trailing P/E (least reliable for Growth)
             if (peRatio !== null && peRatio !== undefined && peRatio > 0 && !isNaN(peRatio)) {
                if (peRatio > 40) {
                    return { value: '‡πÅ‡∏û‡∏á (Overvalued) - TRL PE', class: 'value-bad' };
                } else if (peRatio >= 20) {
                    return { value: '‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á (Fair Value) - TRL PE', class: 'value-neutral' };
                } else {
                    return { value: '‡∏ñ‡∏π‡∏Å (Undervalued) - TRL PE', class: 'value-good' };
                }
            }


            return { value: 'N/A (‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)', class: 'text-gray-500' };
        }
        
        // Function to reset zoom for a specific chart
        window.resetZoom = function(chartId) {
            if (chartInstance[chartId]) {
                chartInstance[chartId].resetZoom();
            }
        };


        // --- UPDATED: renderChart with Zoom/Pan configuration ---
        function renderChart(chartId, historicalDataSubset, yMin, yMax, title) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            
            // Prepare data for Line Chart (Dates as Labels, Close Prices as Data)
            const labels = historicalDataSubset.map(d => d.date);
            const closePrices = historicalDataSubset.map(d => d.close);

            // Prepare EMA data mapped to simple values for the line chart (using index for X)
            const allClosePrices = historicalDataSubset.map(d => d.close);
            const ema50Data = calculateEMA(null, 50, allClosePrices);
            const ema200Data = calculateEMA(null, 200, allClosePrices);
            
            const ema50ChartData = ema50Data;
            const ema200ChartData = ema200Data;

            // Destroy existing chart instance if it exists
            if (chartInstance[chartId]) {
                chartInstance[chartId].destroy();
            }

            chartInstance[chartId] = new Chart(ctx, {
                type: 'line', // CRITICAL: Revert back to line chart
                data: {
                    labels: labels, // Use dates as categorical labels (safest)
                    datasets: [
                        {
                            label: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î (Close Price)',
                            data: closePrices,
                            borderColor: '#3B82F6',  
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true, // Fill area under the line
                            tension: 0.2,
                        },
                        {
                            label: 'EMA 50',
                            data: ema50ChartData,
                            borderColor: '#FBBF24',  
                            backgroundColor: 'transparent',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.2,
                        },
                         {
                            label: 'EMA 200',
                            data: ema200ChartData,
                            borderColor: '#10B981',  
                            backgroundColor: 'transparent',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false,
                            tension: 0.2,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,  
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            color: '#D1D5DB',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            labels: {
                                color: '#D1D5DB'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                // Simple label callback for line chart
                                label: function(context) {
                                    if (context.parsed.y !== null) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                    }
                                    return context.dataset.label;
                                },
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label; // Use the date label
                                }
                            }
                        },
                        // NEW: ZOOM CONFIGURATION (Enabled Pinch/Drag for mobile touch)
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy', // Enable pan on both axes
                                threshold: 5,
                            },
                            zoom: {
                                wheel: {
                                    enabled: true, // Enable zooming with mouse wheel
                                },
                                pinch: {
                                    enabled: true // Enable zooming with pinch gestures (touch)
                                },
                                drag: {
                                    enabled: true, // Enable zooming by dragging/selecting an area
                                    borderColor: 'rgba(59, 130, 246, 0.5)',
                                    borderWidth: 1,
                                    backgroundColor: 'rgba(59, 130, 246, 0.2)'
                                },
                                mode: 'xy', // Zoom on both axes
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category', // CRITICAL: Use category scale to avoid external date adapter issues
                            ticks: {
                                maxRotation: 0, 
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10,  
                                color: '#9CA3AF'
                            },
                            grid: {
                                color: '#374151'
                            },
                            // Allow scale to adapt with zoom/pan
                            min: 0,
                            max: labels.length - 1,  
                        },
                        y: {
                            // Initial min/max kept for context, but zoom/pan will override
                            min: yMin,  
                            max: yMax,
                            title: {
                                display: true,
                                text: 'Price (USD)',
                                color: '#9CA3AF'
                            },
                            ticks: {
                                color: '#9CA3AF'
                            },
                             grid: {
                                color: '#374151'
                            }
                        },
                    },
                }
            });
        }
        // --- END UPDATED renderChart ---


        // Overridden in the main script block to add Accordion logic
        window.runAdvancedAnalysis = async function() {
            const symbolInput = document.getElementById('symbolInput').value.trim().toUpperCase();
            // REMOVED: const dateInput = document.getElementById('dateInput').value.trim(); 
            const analysisOutput = document.getElementById('analysisOutput');  
            const button = document.getElementById('advancedAnalysisButton');
            const strongBuyBanner = document.getElementById('strongBuyBanner');
            
            strongBuyBanner.classList.remove('active'); 

            if (!symbolInput) { // CHECK ONLY SYMBOL INPUT
                analysisOutput.innerHTML = `<p class="error-message">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>`; // Updated error message
                window.updateConnectionStatus('error');
                return;
            }
            
            analysisOutput.innerHTML = `<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-400 mx-auto"></div><p class="mt-2 text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (Advanced Analysis)...</p></div>`;
            button.disabled = true;
            window.updateConnectionStatus('initial');

            try {
                // Pass current date to backend, which will find the latest close date
                const today = new Date().toISOString().split('T')[0];  
                const result = await fetchStockData(symbolInput, today);
                
                displayResults(result, today); // Pass today's date as the target date

                // --- NEW FIX: Auto-open Analysis Accordion and scroll after successful fetch/display ---
                const content = document.getElementById('analysisOutputContent');
                const icon = document.getElementById('analysisIcon');
                
                content.style.maxHeight = "3000px"; 
                content.style.opacity = 1;
                content.classList.add('active-accordion');
                icon.style.transform = 'rotate(180deg)';
                
                // Scroll to the analysis section to show the result immediately
                document.getElementById('analysisCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
                // --- END NEW FIX ---

            } catch (error) {
                console.error('Analysis Error: Backend Server FAILED. This is NOT a frontend (HTML/JS) error. See details below. Check your Python/Cloud Run logs.', error);  
                
                let errorMessage = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ: ${error.message}`;
                
                if (error.message.includes('This method is not implemented') || error.message.includes('startOfDay')) {
                    // Note: This error should no longer appear after the fix, but kept for robustness
                    errorMessage = `**‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü:** ${error.message}. <br>‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° **‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å** ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î **Date Adapter** (date-fns) ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô <script> ‡∏Ç‡∏≠‡∏á HTML ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß`;
                }
                else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    const currentBackendHost = CLOUD_RUN_HOST;
                    
                    errorMessage = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Python Backend Server ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà ${currentBackendHost}. 
                                            ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: 1) Cloud Run Service ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà (Min Instances = 1) 
                                            2) **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:** ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå backend_server.py ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ API_KEY ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Environment Variable ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà 
                                            3) ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö **Cloud Run Logs** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (Status 500) ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Server`;
                } else if (error.message.includes('Server responded with status 404')) {
                    errorMessage = `**‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏´‡∏∏‡πâ‡∏ô '${symbolInput}' ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏`;
                } else if (error.message.includes('Server responded with status 500')) {
                    errorMessage = `**‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Server (Status 500):** Server Backend (Python) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡πÅ‡∏•‡∏∞ Crash ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏ä‡πà‡∏ô \`RuntimeError\`). 
                                             <br>**(‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console Log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Error Stacktrace)**
                                             <br><br>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢: 1. **Docker/Async Logic:** ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Gunicorn Worker Class ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Async (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ \`--worker-class gevent\` ‡πÉ‡∏ô Dockerfile CMD)
                                             2. **Gemini API Key:** Key ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (403)
                                             <br>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö **Dockerfile CMD** ‡πÅ‡∏•‡∏∞ **Cloud Run Logs** ‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                             <br>Server Error Detail: <pre class="whitespace-pre-wrap text-sm text-red-400 bg-gray-900 p-3 rounded-lg mt-2">${error.message}</pre>`;
                }


                analysisOutput.innerHTML = `<p class="error-message font-semibold">${errorMessage}</p>`;
                window.updateConnectionStatus('error');
            } finally {
                setTimeout(() => {
                    button.disabled = false;
                }, 50);
            }
        }

        function displayResults(result, targetDateStr) {
            const { data, isMock, companyInfo, news } = result; // Destructure news
            const analysisOutput = document.getElementById('analysisOutput');
            const symbolInput = document.getElementById('symbolInput').value.trim().toUpperCase();  
            const strongBuyBanner = document.getElementById('strongBuyBanner');
            
            strongBuyBanner.classList.remove('active'); 

            // Simplified logic: Rely on the last data point returned by the backend
            let latestAvailableData = data[data.length - 1];
            let actualAnalysisDate = latestAvailableData.date; // The date the data is actually from
            let targetData = latestAvailableData; // The data point used for analysis
            

            if (!targetData) {
                analysisOutput.innerHTML = `<p class="error-message">**‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á:** ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤</p>`;
                strongBuyBanner.classList.remove('active');
                return;
            }

            // --- DATA PREPARATION FOR MULTIPLE CHARTS ---
            const allClosePrices = data.map(d => d.close);
            const globalMinPrice = Math.min(...allClosePrices);
            const globalMaxPrice = Math.max(...allClosePrices);
            const yMin = globalMinPrice * 0.95;  
            const yMax = globalMaxPrice * 1.05;  
            
            // 1 YEAR (approx 250 trading days)
            const data1Y = data.slice(-250);  
            
            // 3 YEARS (Full data returned from backend is 3y)
            const data3Y = data;  
            
            // --- END DATA PREPARATION ---


            const currentPrice = targetData.close;
            const previousDayData = data.slice(0, data.findIndex(d => d.date === actualAnalysisDate)).pop();  
            const previousClose = previousDayData ? previousDayData.close : targetData.open;  
            
            const priceChange = currentPrice - previousClose;
            const percentageChange = (priceChange / previousClose) * 100;

            const changeColorClass = priceChange > 0 ? 'text-green-500' : priceChange < 0 ? 'text-red-500' : 'text-gray-400';
            const changeSign = priceChange > 0 ? '+' : '';
            const priceChangeDisplay = `${changeSign}${priceChange.toFixed(2)} (${changeSign}${percentageChange.toFixed(2)}%)`;


            const historicalDataUntilTarget = data.filter(d => d.date <= actualAnalysisDate);
            const closePrices = historicalDataUntilTarget.map(d => d.close);
            const currentVolume = targetData.volume;


            const volume20Day = historicalDataUntilTarget.slice(-20).map(d => d.volume);
            const volumeAvg = volume20Day.reduce((a, b) => a + b, 0) / volume20Day.length;


            const ema200All = calculateEMA(data, 200, allClosePrices);
            const ema50All = calculateEMA(data, 50, allClosePrices);
            const ema26All = calculateEMA(data, 26, allClosePrices);
            const ema12All = calculateEMA(data, 12, allClosePrices);
            
            
            const index = data.findIndex(d => d.date === actualAnalysisDate);

            const indicators = {
                EMA12: index !== -1 && ema12All.length > index ? ema12All[index] : null,
                EMA26: index !== -1 && ema26All.length > index ? ema26All[index] : null,
                EMA50: index !== -1 && ema50All.length > index ? ema50All[index] : null,
                EMA200: index !== -1 && ema200All.length > index ? ema200All[index] : null,
                RSI: calculateRSI(closePrices, 14),
                MACD: calculateMACD(closePrices),
                BB: calculateBollingerBands(historicalDataUntilTarget, 20, 2),
                Volume: currentVolume,
            };

            // ** FIX: Call technical analysis for Targets/SL, even if signal is overridden **
            const technicalAnalysis = analyzeMultiIndicatorSignal(currentPrice, indicators, volumeAvg);  
            // ** NEW: OVERRIDE SIGNAL WITH AI HYBRID ANALYSIS **
            const aiHybridResult = extractAISignal(companyInfo.summary);
            const currentSignal = aiHybridResult.signal;  
            // We do not use the AI Rationale list directly here, we use the raw text for the pre-wrap block.
            
            // --- NEW: Combine AI Rationale and Technical Rationale in SEPARATE SECTIONS ---
            let fundamentalRationaleHTML = "";
            const aiSummaryText = (companyInfo.summary || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI').trim();
            
            if (aiSummaryText.length > 0) {
                     // ** IMPROVED: Use CSS 'white-space: pre-wrap' to perfectly preserve paragraph breaks and formatting from the AI summary. **
                     fundamentalRationaleHTML = `
                         <div class="mt-4 border-t border-gray-600 pt-3">
                             <p class="font-bold text-base text-yellow-400 mb-2">üìä ‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (AI Narrative)</p>
                             <div class="p-3 bg-gray-800 rounded-lg border border-yellow-700/50 text-sm text-gray-300" style="white-space: pre-wrap;">
                                 ${aiSummaryText}
                             </div>
                         </div>
                       `;
            }

            let technicalRationaleHTML = "";
            if (technicalAnalysis.rationaleList.length > 0) {
                technicalRationaleHTML = `
                    <div class="mt-4 border-t border-gray-600 pt-3">
                        <p class="font-bold text-base text-blue-400 mb-2">üìà ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î)</p> <ul class="list-disc list-inside text-sm text-gray-300 space-y-1">
                            ${technicalAnalysis.rationaleList.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            let finalRationaleContent = `
                <div class="font-bold text-lg text-gray-200 mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à: <span class="text-xl ${currentSignal.includes('BUY') ? 'text-green-400' : currentSignal.includes('SELL') ? 'text-red-400' : 'text-yellow-400'}">${currentSignal}</span></div>
                <p class="text-sm text-gray-400">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡πÇ‡∏î‡∏¢ AI ‡πÇ‡∏î‡∏¢‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á/‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢:</p>
                ${fundamentalRationaleHTML}
                ${technicalRationaleHTML}
            `;
            // --- END NEW COMBINE ---
            
            // NOTE: We still calculate the Technical Trend Strength for display purposes, 
            // but the final signal is dictated by AI.
            const trendStrength = calculateTrendStrength(currentPrice, indicators, volumeAvg);
            
            
            // --- CRITICAL PEG CALCULATION AND VALUATION UPDATE ---
            // Step 1: Calculate PEG using Forward P/E and EPS Growth (as decimal)
            const calculatedPegRatio = calculatePegRatio(companyInfo.forward_pe, companyInfo.eps_growth);
            // Step 2: Use the calculated PEG Ratio for Valuation Analysis
            const valuation = analyzeValuation(companyInfo.pe_ratio, companyInfo.forward_pe, calculatedPegRatio);
            // --- END CRITICAL PEG CALCULATION AND VALUATION UPDATE ---

            const currentStockName = companyInfo.name || symbolInput;
            
            if (currentSignal === 'STRONG BUY' || currentSignal === 'BUY') {
                document.getElementById('bannerText').textContent = `‚≠ê ${currentSignal} ALERT! (${currentStockName}) ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á`;
                strongBuyBanner.classList.add('active');
            } else {
                strongBuyBanner.classList.remove('active');
            }
            
            // REMOVED: dateWarning logic
            let mockWarning = '';
            // Note: Remove mock warning as we are now using the DOM retrieval logic
            // The EPS Growth display will use the final value (from Backend or DOM).

            let signalClass = currentSignal.includes('BUY') ? 'buy' : currentSignal.includes('SELL') ? 'sell' : 'hold';

            const peDisplay = (companyInfo.pe_ratio !== null && companyInfo.pe_ratio !== undefined && companyInfo.pe_ratio > 0)
                ? companyInfo.pe_ratio.toFixed(2)
                : 'N/A';
            
            const forwardPEDisplay = (companyInfo.forward_pe !== null && companyInfo.forward_pe !== undefined && companyInfo.forward_pe > 0)
                ? companyInfo.forward_pe.toFixed(2)
                : 'N/A';
            
            // PEG Display now uses the calculated value (if available), otherwise falls back to N/A
            const pegDisplay = (calculatedPegRatio !== null && calculatedPegRatio !== undefined && calculatedPegRatio > 0)
                ? calculatedPegRatio.toFixed(2)
                : 'N/A';


            const epsDisplay = (companyInfo.eps !== null && companyInfo.eps !== undefined) ? companyInfo.eps.toFixed(2) : 'N/A';
            
            const cleanCompanyName = (companyInfo.name || symbolInput).replace(/\(.*\)/g, '').trim();

            // --- NEW FINANCIAL RATIOS DISPLAY ---
            const roeRaw = companyInfo.return_on_equity;
            const roeDisplay = (roeRaw !== null && roeRaw !== undefined)
                ? `${(roeRaw * 100).toFixed(2)}%`
                : 'N/A';
            
            const netMarginRaw = companyInfo.net_margin;
            const netMarginDisplay = (netMarginRaw !== null && netMarginRaw !== undefined)
                ? `${(netMarginRaw * 100).toFixed(2)}%`
                : 'N/A';
            
            const epsGrowthRaw = companyInfo.eps_growth; // ADDED: EPS Growth
            // NOTE: This value is either from Backend or from DOM retrieval logic now.
            const epsGrowthDisplay = (epsGrowthRaw !== null && epsGrowthRaw !== undefined)
                ? `${(epsGrowthRaw * 100).toFixed(2)}%`
                : 'N/A';
            // --- END NEW FINANCIAL RATIOS DISPLAY ---


            const dataAndStatsHTML = `
                 <div class="bg-gray-800 rounded-lg p-3 mb-4 border border-blue-600/50">
                    <h4 class="text-lg font-bold text-gray-100 mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å ‡∏ì ${actualAnalysisDate}</h4>
                    
                    <p class="text-2xl font-semibold mb-2 text-gray-200 flex items-center justify-between">
                        ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏¥‡∏î: 
                        <span class="target-price text-3xl text-blue-400 ml-2">${currentPrice.toFixed(2)}</span>
                    </p>
                    <p class="text-base font-semibold ${changeColorClass} mb-3">
                         ${priceChangeDisplay}
                    </p>

                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-400 border-t border-gray-700 pt-3">
                        <div><span class="font-semibold text-gray-400">‡πÄ‡∏õ‡∏¥‡∏î/‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥:</span> ${targetData.open ? targetData.open.toFixed(2) : 'N/A'} / ${targetData.high ? targetData.high.toFixed(2) : 'N/A'} / ${targetData.low ? targetData.low.toFixed(2) : 'N/A'}</div> <div><span class="font-semibold text-gray-400">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢:</span> ${targetData.volume ? formatMarketCap(targetData.volume) : 'N/A'}</div> <div><span class="font-semibold text-gray-400">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î:</span> ${formatMarketCap(companyInfo.market_cap)}</div> <div><span class="font-semibold text-gray-400">‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°/‡∏´‡∏°‡∏ß‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à:</span> ${companyInfo.sector || 'N/A'} / ${companyInfo.industry || 'N/A'}</div> </div>
                </div>


                <div class="bg-gray-800 rounded-lg p-4 border border-green-600/50 mb-4">
                    <h3 class="text-xl font-bold text-gray-100 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</h3>
                    
                    <div class="flex items-center justify-between mb-3 border-b border-gray-700 pb-3">
                        <p class="text-lg text-gray-200">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì: <span id="tradeSignal" class="signal-box ${signalClass}">${currentSignal}</span></p>
                        <p class="text-sm font-semibold text-gray-200 text-right">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°: 
                            <span class="strength-indicator ${trendStrength.colorClass}">${trendStrength.strength}</span>
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div class="p-2 bg-gray-900 rounded-lg border border-blue-700">
                            <p class="text-xs font-medium text-blue-400">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ã‡∏∑‡πâ‡∏≠)</p> <p id="buyTarget" class="target-price text-lg">${technicalAnalysis.buyTarget}</p>
                            <p class="text-xs text-gray-500">(‡πÅ‡∏ô‡∏ß‡∏£‡∏±‡∏ö)</p>
                        </div>
                        <div class="p-2 bg-gray-900 rounded-lg border border-red-700">
                            <p class="text-xs font-medium text-red-400">‡∏à‡∏∏‡∏î‡∏ï‡∏±‡∏î‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</p> <p id="stopLoss" class="target-price text-lg text-red-400">${technicalAnalysis.stopLoss}</p>
                            <p class="text-xs text-gray-500">(Lower BB / EMA 50)</p>
                        </div>
                        <div class="p-2 bg-gray-900 rounded-lg border border-green-700">
                            <p class="text-xs font-medium text-green-400">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏Ç‡∏≤‡∏¢)</p> <p id="sellTarget" class="target-price text-lg text-green-400">${technicalAnalysis.sellTarget}</p>
                            <p class="text-xs text-gray-500">(‡πÅ‡∏ô‡∏ß‡∏ï‡πâ‡∏≤‡∏ô)</p>
                        </div>
                    </div>

                    <div class="mt-4">
                         ${finalRationaleContent}
                    </div>

                </div>

                <div class="bg-gray-800 rounded-lg p-4 border border-yellow-600/50 mb-4">
                    <h3 class="text-xl font-bold text-gray-100 mb-4">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</h3> <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-gray-900 p-2 rounded-lg">
                            <span class="block text-xs font-semibold text-gray-400">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</span> <span class="text-lg ${valuation.class} font-bold mt-1">(${valuation.value.split(' - ')[0]})</span>
                            <span class="block text-xs font-semibold mt-1 text-gray-500">${valuation.value.includes('-') ? `(${valuation.value.split(' - ')[1]})` : ''}</span>
                        </div>
                        <div class="bg-gray-900 p-2 rounded-lg">
                            <span class="block text-xs font-semibold text-gray-400">PEG Ratio</span>
                            <span class="text-xl text-yellow-400 font-bold">${pegDisplay}</span>
                            <span class="block text-xs font-semibold mt-1 text-gray-500">(‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï)</span> </div>
                         <div class="bg-gray-900 p-2 rounded-lg">
                            <span class="block text-xs font-semibold text-gray-400">P/E (‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå)</span> <span class="text-xl text-green-400 font-bold">${forwardPEDisplay}</span>
                            <span class="block text-xs font-semibold mt-1 text-gray-500">(‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏≥‡πÑ‡∏£)</span> </div>
                         <div class="bg-gray-900 p-2 rounded-lg">
                            <span class="block text-xs font-semibold text-gray-400">‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á EPS (YoY)</span> <span class="text-xl text-yellow-400 font-bold">${epsGrowthDisplay}</span>
                            <span class="block text-xs font-semibold mt-1 text-gray-500">(‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)</span> </div>
                        <div class="bg-gray-900 p-2 rounded-lg">
                            <span class="block text-xs font-semibold text-gray-400">ROE</span>
                            <span class="text-xl text-yellow-400 font-bold">${roeDisplay}</span>
                            <span class="block text-xs font-semibold mt-1 text-gray-500">(‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏ï‡πà‡∏≠‡∏ó‡∏∏‡∏ô)</span>
                        </div>
                        <div class="bg-gray-900 p-2 rounded-lg">
                            <span class="block text-xs font-semibold text-gray-400">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span> <span class="text-xl text-yellow-400 font-bold">${netMarginDisplay}</span>
                            <span class="block text-xs font-semibold mt-1 text-gray-500">(Net Margin)</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-100 mb-4 border-b border-gray-700 pb-2">‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</h3>
                    
                    <div class="mb-6">
                        <div class="chart-container-wrapper">
                            <div class="chart-container-inner" style="height: 300px;">
                                <canvas id="stockChart1Y"></canvas>
                            </div>
                        </div>
                        <div class="text-center">
                            <button onclick="window.resetZoom('stockChart1Y')" class="reset-button text-xs">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Zoom 1 ‡∏õ‡∏µ</button>
                        </div>
                    </div>

                    <div>
                        <div class="chart-container-wrapper">
                            <div class="chart-container-inner" style="height: 300px;">
                                <canvas id="stockChart3Y"></canvas>
                            </div>
                        </div>
                        <div class="text-center">
                            <button onclick="window.resetZoom('stockChart3Y')" class="reset-button text-xs">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Zoom 3 ‡∏õ‡∏µ</button>
                        </div>
                    </div>
                </div>

            `;
            
            analysisOutput.innerHTML = dataAndStatsHTML;
            // Call renderChart for each period
            renderChart('stockChart1Y', data1Y, yMin, yMax, `${symbolInput} - ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤ 1 ‡∏õ‡∏µ`);
            renderChart('stockChart3Y', data3Y, yMin, yMax, `${symbolInput} - ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤ 3 ‡∏õ‡∏µ`);  
            
        }
        
        function setupStockDatalist() {
            const datalist = document.createElement('datalist');
            datalist.id = 'stockSuggestions';
            MOCK_TICKERS.forEach(ticker => {
                const option = document.createElement('option');
                option.value = ticker.split(' - ')[0];  
                option.textContent = ticker;          
                datalist.appendChild(option);
            });
            document.body.appendChild(datalist);
            document.getElementById('symbolInput').setAttribute('list', 'stockSuggestions');
        }

        // NEW: Ticker Examples/Guide Setup
        function setupTickerExamples() {
            const examples = [
                "üá∫üá∏ ‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏´‡∏£‡∏±‡∏ê: AAPL, MSFT, GOOG, TSLA",
                "üáπüá≠ ‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏ó‡∏¢ (SET): CPALL.BK, AOT.BK (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ .BK ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢)",
                "ü™ô Commodity/ETF: GLD, GC=F (Gold Futures)",
                "‚Çø Crypto: BTC-USD, ETH-USD",
                "‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Ticker ‡πÉ‡∏ô yfinance ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á"
            ];

            const examplesHtml = `
                <p class="font-bold text-gray-300 mb-1">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Ticker ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö:</p>
                <ul class="list-disc list-inside ml-2 space-y-1 text-gray-400">
                    ${examples.map(ex => `<li>${ex}</li>`).join('')}
                </ul>
                <p class="mt-2 text-red-400">**‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:** ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Ticker ‡∏™‡∏≤‡∏Å‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
            `;

            document.getElementById('tickerExamples').innerHTML = examplesHtml;

            document.getElementById('toggleTickerExamples').addEventListener('click', () => {
                const examplesDiv = document.getElementById('tickerExamples');
                const button = document.getElementById('toggleTickerExamples');
                const isHidden = examplesDiv.classList.toggle('hidden');
                button.textContent = isHidden ? '[‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á]' : '[‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á]';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupStockDatalist();  
            setupTickerExamples(); // Setup the new feature
            
            // Attach runAdvancedAnalysis to the button
            document.getElementById('advancedAnalysisButton').addEventListener('click', window.runAdvancedAnalysis);  
            // Note: addToWatchlistButton listener is now set up below (in the grid)
             document.getElementById('addTickerFromInput').addEventListener('click', window.addTickerToWatchlist);


            // Initialize Firebase and start listening to Watchlist
            initFirebase();  
            
            const initialSymbol = document.getElementById('symbolInput').value;
            if (initialSymbol) {
                fetchAndDisplayBasicInfo(initialSymbol);
            }
        });
    </script> 
</head>
<body>
    <div id="strongBuyBanner" class="text-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
        </svg>
        <span id="bannerText"></span>
    </div>

    <div id="connectionStatusContainer">
        <div id="connectionStatusIcon" class="status-icon status-initial">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                 <path fill-rule="evenodd" d="M8.257 3.099c.765-1.554 2.656-1.554 3.42 0L15.46 11.2a1.75 1.75 0 01-1.574 2.55H6.114a1.75 1.75 0 01-1.573-2.55l3.42-8.101zM10 14a1 1 0 100 2 1 1 0 000-2zm-1-6a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" />
             </svg>
        </div>
    </div>

    <div class="container-wrapper">
        <div class="card app-header">
            
            <div class="grid grid-cols-2 gap-3 mb-3">
                
                <div class="col-span-1">
                    <div class="flex justify-between items-end">
                        <label for="symbolInput" class="block text-xs font-medium text-gray-400 mb-1">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (Ticker)</label>
                        <button id="toggleTickerExamples" class="text-xs text-blue-400 hover:text-blue-300 font-semibold transition duration-150">
                            [‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á]
                        </button>
                    </div>
                    <div class="flex space-x-1">
                         <input type="text" id="symbolInput" oninput="window.handleSymbolInput(this.value)" class="flex-grow p-2 border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-base" placeholder="AAPL" value="GOOG" list="stockSuggestions" style="font-size: 1rem !important; height: 44px;">
                         <button id="addTickerFromInput" class="p-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150 text-sm flex items-center justify-center flex-shrink-0" style="width: 44px; height: 44px;">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                 <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                             </svg>
                         </button>
                    </div>
                </div>

                <div class="col-span-1 border border-gray-700 rounded-lg h-full flex flex-col">
                    <div id="watchlistHeader" class="accordion-header flex justify-between items-center flex-shrink-0" onclick="toggleAccordion('watchlistListContent', 'watchlistIcon')" style="height: 44px; padding: 10px 14px;">
                        <h3 class="text-sm font-bold text-gray-100 flex items-center truncate">
                             ‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π <span class="text-xs ml-2 text-gray-500 truncate" id="userIdDisplay"></span>
                        </h3> 
                        <svg id="watchlistIcon" class="w-4 h-4 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="watchlistListContent" class="accordion-content max-h-0 opacity-0 px-4" style="padding-left: 1rem; padding-right: 1rem; flex-grow: 1;">
                        <div id="watchlistList" class="space-y-2 pb-2">
                             <p class="text-gray-500 text-center py-4 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π...</p>
                        </div>
                    </div>
                </div>
            </div> 
            <div id="tickerExamples" class="p-3 bg-gray-900 rounded-lg text-xs hidden border border-blue-700/50">
                </div>
            <div id="watchlistMessage" class="mt-2"></div>
            
        </div>

        <div id="fixedActionButtonContainer">
             <button id="advancedAnalysisButton" onclick="window.runAdvancedAnalysis()" disabled class="bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl shadow-lg transition duration-150 ease-in-out">
                 üö® ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å </button>
        </div>
        <div class="mt-4">
            <div class="card p-0" id="basicInfoCard">
                <div class="accordion-header flex justify-between items-center" onclick="toggleAccordion('basicInfoContent', 'basicInfoIcon')">
                    <h3 class="text-lg font-bold text-gray-100">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h3> <svg id="basicInfoIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="basicInfoContent" class="accordion-content max-h-0 opacity-0 px-4">
                    <div id="basicInfoDisplay">
                        <p class="text-gray-400 p-4 border border-gray-700 rounded-lg bg-gray-800 text-center">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏´‡∏∏‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</p>
                    </div>
                </div>
            </div>
        </div>
        

        <div class="mt-4">
            <div class="card p-0" id="analysisCard">
                <div class="accordion-header flex justify-between items-center" onclick="toggleAccordion('analysisOutputContent', 'analysisIcon')">
                    <h3 class="text-lg font-bold text-gray-100">2. ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢</h3> <svg id="analysisIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="analysisOutputContent" class="accordion-content max-h-0 opacity-0 px-4">
                    <div id="analysisOutput">
                        <p class="text-gray-400 p-4 border border-gray-700 rounded-lg bg-gray-800">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° **‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å** ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p> </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleAccordion(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            
            // Check if element is currently visible (expanded)
            const isExpanded = content.classList.contains('active-accordion');

            if (isExpanded) {
                // Collapse logic
                content.style.maxHeight = null;
                content.style.opacity = 0;
                content.classList.remove('active-accordion');
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Expand logic
                // Temporarily set a large max-height before getting the actual scroll height
                content.style.maxHeight = "3000px"; 
                content.style.opacity = 1;
                content.classList.add('active-accordion');
                icon.style.transform = 'rotate(180deg)';
                
                // Special case for Watchlist: Scroll into view if expanded on mobile (optional, as main input is at the top)
                if (contentId === 'watchlistListContent') {
                     // Find the header element
                     const header = document.querySelector(`#${contentId}`).previousElementSibling;
                     if (window.innerWidth < 640 && header) { // Apply only on mobile (Tailwind sm: breakpoint)
                          // Scroll to the watchlist header when expanded to ensure it's visible
                          header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                     }
                }
            }
        }
        
        // Initial state for the accordions
        document.addEventListener('DOMContentLoaded', () => {
             // Set up click listeners for the accordion headers
             // Initial accordion state: collapsed.
             document.getElementById('basicInfoContent').style.maxHeight = null;
             document.getElementById('analysisOutputContent').style.maxHeight = null;
             document.getElementById('watchlistListContent').style.maxHeight = null; // New watchlist accordion init

             // Ensure initial info is fetched on load, and open the Basic Info Accordion
             const initialSymbol = document.getElementById('symbolInput').value;
             if (initialSymbol) {
                 // Open basic info accordion by default if a symbol is present
                 const content = document.getElementById('basicInfoContent');
                 content.style.maxHeight = "3000px"; // Use a large fixed value for initialization
                 content.style.opacity = 1;
                 content.classList.add('active-accordion');
                 document.getElementById('basicInfoIcon').style.transform = 'rotate(180deg)';
             }
        });

        // Override original handleSymbolInput to re-open accordion on fetch
        const originalHandleSymbolInput = window.handleSymbolInput;
        window.handleSymbolInput = function(symbol) {
             originalHandleSymbolInput(symbol);
             // Ensure basic info accordion is open when a new symbol is entered
             const content = document.getElementById('basicInfoContent');
             const icon = document.getElementById('basicInfoIcon');
             if (!content.classList.contains('active-accordion')) {
                 content.style.maxHeight = "3000px";
                 content.style.opacity = 1;
                 content.classList.add('active-accordion');
                 icon.style.transform = 'rotate(180deg)';
             }
        }

        // Override original runAdvancedAnalysis to open the Analysis Accordion
        const originalRunAdvancedAnalysis = window.runAdvancedAnalysis;
        window.runAdvancedAnalysis = async function() {
             await originalRunAdvancedAnalysis();
             // The logic to open and scroll the analysis accordion is inside the originalRunAdvancedAnalysis (displayResults)
        }
    </script>
</body>
</html>
